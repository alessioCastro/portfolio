<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        /* Estilos do banner */
        #lang-suggest {
            position: fixed;
            bottom: 18px;
            right: 18px;
            width: 320px;
            max-width: calc(100% - 36px);
            background: linear-gradient(180deg, #ffffff, #fbfbff);
            border: 1px solid rgba(30, 30, 30, 0.08);
            padding: 14px;
            border-radius: 12px;
            z-index: 9999;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            box-shadow: 0 8px 30px rgba(16, 24, 40, 0.08);
            color: #111827;
        }

        #lang-suggest .title {
            font-size: 15px;
            margin-bottom: 6px;
        }

        #lang-suggest .subtitle {
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 10px;
        }

        #lang-suggest .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-primary {
            background: linear-gradient(180deg, #0066d6, #0053b8);
            color: #fff;
            box-shadow: 0 2px 8px rgba(3, 102, 214, 0.12);
        }

        .btn-ghost {
            background: #f3f4f6;
            color: #111827;
        }

        .btn-small {
            padding: 6px 8px;
            font-size: 12px;
        }

        .progress {
            height: 6px;
            width: 100%;
            background: #eef2ff;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress>i {
            display: block;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #7c3aed, #4f46e5);
            transform-origin: left;
            transition: transform 0.25s linear;
        }

        .count {
            font-weight: 600;
            margin-left: auto;
            font-size: 13px;
            color: #0f172a;
        }

        @media (max-width: 420px) {
            #lang-suggest {
                width: calc(100% - 36px);
                right: 18px;
                left: 18px;
            }

            .count {
                display: none;
            }
        }
    </style>
</head>

<body>
    <script>
        // Configuração: atraso em milissegundos antes do redirecionamento automático
        const REDIRECT_DELAY_MS = 8000;

        // Idiomas suportados
        const SUPPORTED = ['pt', 'en'];

        // Mapeamento para nomes legíveis
        const LANG_NAME = { pt: 'Português', en: 'English' };

        // Normaliza tags BCP47 para comparação simples
        function norm(tag) {
            return (tag || '').trim().toLowerCase();
        }

        // Verifica se uma tag (ex: "pt-BR" ou "en-US") bate com pt ou en
        function matchSimple(tag) {
            if (!tag) return null;
            const p = norm(tag).split('-')[0];
            return SUPPORTED.includes(p) ? p : null;
        }

        // Obtém preferências do navegador com fallback
        function getBrowserPrefs() {
            const langs = [];
            if (Array.isArray(navigator.languages) && navigator.languages.length) {
                langs.push(...navigator.languages);
            }
            if (navigator.language) langs.push(navigator.language);
            if (navigator.userLanguage) langs.push(navigator.userLanguage);
            return langs.map(l => l).filter(Boolean);
        }

        // Variável para controlar timeout e progresso
        let redirectTimeout = null;
        let progressInterval = null;
        let remainingMs = REDIRECT_DELAY_MS;

        // Decide e agenda redirecionamento ou mostra sugestão
        function smartLangRedirect() {
            const prefs = getBrowserPrefs();
            for (const p of prefs) {
                const m = matchSimple(p);
                if (m) return scheduleRedirect(m);
            }

            // Se não encontrou correspondência, sugere sem forçar (fallback pt)
            const suggested = matchSimple(prefs[0]) || 'pt';
            showBanner(suggested, false);
        }

        function scheduleRedirect(lang) {
            // Se já estamos na rota, não faz nada
            const curSegment = location.pathname.replace(/^\/+|\/+$/g, '').split('/')[0];
            if (curSegment && curSegment === lang) return;

            // Mostra banner com opção de cancelar/ir agora
            showBanner(lang, true);

            // Agendar redirecionamento automático
            clearRedirectTimeout();
            remainingMs = REDIRECT_DELAY_MS;
            redirectTimeout = setTimeout(() => doRedirect(lang), remainingMs);

            // iniciar animação de progresso e contagem regressiva
            startProgress(lang);
        }

        function clearRedirectTimeout() {
            if (redirectTimeout) {
                clearTimeout(redirectTimeout);
                redirectTimeout = null;
            }
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function doRedirect(lang) {
            clearRedirectTimeout();
            const currentHref = location.origin + location.pathname;
            const targetHref = currentHref + '/' + lang + '/';
            if (currentHref && currentHref === targetHref) return; // já está na versão
            location.href = targetHref;
        }

        function showBanner(suggested, showCancel = false) {
            const MESSAGES = {
                pt: {
                    message: (label) => `Parece que você prefere ${label}`,
                    subtitle: (label) => `Redirecionando para a versão <strong>${label}</strong> automaticamente.`,
                    maintain: 'Manter esta página',
                    cancel: 'Cancelar'
                },
                en: {
                    message: (label) => `Looks like you prefer ${label}`,
                    subtitle: (label) => `Redirecting to the <strong>${label}</strong> version automatically.`,
                    maintain: 'Keep this page',
                    cancel: 'Cancel'
                }
            };

            if (document.getElementById('lang-suggest')) return;

            const b = document.createElement('div');
            b.id = 'lang-suggest';

            const languageLabel = LANG_NAME[suggested] || suggested;
            const suggestedLocale = suggested === 'pt' ? 'pt' : 'en';
            const currentMessages = MESSAGES[suggestedLocale] || MESSAGES.en;

            document.title = suggested === 'pt' ? `Redirecionando para ${languageLabel}...` : `Redirecting to ${languageLabel}...`;

            b.innerHTML = `
                <div class="title">${currentMessages.message(languageLabel)}</div>
                <div class="subtitle">${currentMessages.subtitle(languageLabel)}</div>
                <div class="controls">
                    <button id="goLang" class="btn btn-primary">${languageLabel}</button>
                    <button id="closeLang" class="btn btn-ghost btn-small">${currentMessages.maintain}</button>
                    ${showCancel ? `<button id="cancelAuto" class="btn btn-ghost btn-small">${currentMessages.cancel}</button>` : ''}
                    <div class="count" id="count">8s</div>
                </div>
                <div class="progress" aria-hidden="true"><i id="progressBar" style="transform:scaleX(1)"></i></div>
            `;

            document.body.appendChild(b);

            document.getElementById('goLang').addEventListener('click', () => {
                clearRedirectTimeout();
                doRedirect(suggested);
            });

            document.getElementById('closeLang').addEventListener('click', () => {
                clearRedirectTimeout();
                b.remove();
            });

            if (showCancel) {
                document.getElementById('cancelAuto').addEventListener('click', () => {
                    clearRedirectTimeout();
                    const btn = document.getElementById('cancelAuto');
                    if (btn) btn.textContent = 'Cancelado';
                    setTimeout(() => b.remove(), 900);
                });
            }

            // fechar banner ao navegar ou interagir com teclado para não deixar preso
            ['keydown', 'click', 'touchstart'].forEach(evt => {
                const handler = () => {
                    clearRedirectTimeout();
                    ['keydown', 'click', 'touchstart'].forEach(e => document.removeEventListener(e, handler));
                };
                document.addEventListener(evt, handler, { once: true });
            });
        }

        function startProgress(lang) {
            const progressBar = document.getElementById('progressBar');
            const countEl = document.getElementById('count');
            if (!progressBar || !countEl) return;

            const start = Date.now();
            const total = REDIRECT_DELAY_MS;

            // atualiza a cada 250ms
            progressInterval = setInterval(() => {
                const elapsed = Date.now() - start;
                const remaining = Math.max(total - elapsed, 0);
                const fraction = Math.max(0, 1 - (elapsed / total));
                progressBar.style.transform = 'scaleX(' + fraction + ')';
                const seconds = Math.ceil(remaining / 1000);
                countEl.textContent = seconds + 's';
                if (remaining <= 0) {
                    clearRedirectTimeout();
                }
            }, 250);
        }

        // Executa ao carregar a página
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', smartLangRedirect);
        } else {
            smartLangRedirect();
        }
    </script>
</body>

</html>
